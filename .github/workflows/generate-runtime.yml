name: Generate Runtime

on:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate Runtime JS
        run: |
          mkdir -p hsx/Flows/runtimes
          for DIR in hsx/Flows/projects/*; do
            LANG_NAME=$(basename "$DIR")
            LANG_FILE="$DIR/language.txt"
            SAMPLE_FILE=$(ls "$DIR"/*.language 2>/dev/null | head -n 1)
            RUNTIME_FILE="hsx/Flows/runtimes/${LANG_NAME}-runtime.js"

            echo "// Auto-generated runtime for $LANG_NAME" > "$RUNTIME_FILE"

            # Convert language commands to JS functions
            while IFS=: read -r command desc; do
              if [ -n "$command" ]; then
                echo "function ${command// /_}() { console.log('Executing $command'); }" >> "$RUNTIME_FILE"
              fi
            done < "$LANG_FILE"

            # Add sample code execution
            echo "// Execute sample code" >> "$RUNTIME_FILE"
            if [ -f "$SAMPLE_FILE" ]; then
              while IFS= read -r line; do
                CMD=$(echo "$line" | awk '{print $1}')
                echo "${CMD}();" >> "$RUNTIME_FILE"
              done < "$SAMPLE_FILE"
            fi
          done

      - name: Generate HTML if missing
        run: |
          for DIR in hsx/Flows/projects/*; do
            HTML_FILE="$DIR/example.html"
            RUNTIME_FILE="../../runtimes/$(basename "$DIR")-runtime.js"
            if [ ! -f "$HTML_FILE" ]; then
cat <<EOL > "$HTML_FILE"
<!DOCTYPE html>
<html>
<head>
  <title>Run $(basename "$DIR")</title>
  <script src='$RUNTIME_FILE'></script>
</head>
<body>
<h1>Run $(basename "$DIR")</h1>
</body>
</html>
EOL
            fi
          done
